DOSVAX
=======
GitHub からバイナリとソース コードを取得できます。 <https://github.com/akmed772/dosvax>.

### ライセンス

ドキュメントやソースコードに特に記載が無ければGNU GPLv2。ABOUT_LIBSも参照。

### 機能

俗に「日本語PC/AT互換機」と呼ばれるAX仕様のパソコンを再現したエミュレータです。これは DOSBox のフォークであり、IBM PC ソフトウェアと DOS/V を実行することができますが、目標は AX マシン用に開発されたアプリケーションを実行することです。AX用の日本語MS-DOSをご用意ください。BIOS ROM は必要ありませんが、日本語の文字を表示するには、日本語の FONTX2 フォント ファイルを作成する必要があります。

また、日本IBM PS/55 モデル 5550-S/T/V と同等の PS/55 テキスト モード エミュレーションを実験的に実装しています。

### 特徴

* AX-1システム仕様相当の日本語テキスト・グラフィック画面表示機能を実装
* 日英モード切替（バイリンガル）に対応
* AXキーボード固有のキーを割り当てられるように拡張

### 非対応・制約事項

* AX-2での拡張機能(テキスト画面とグラフィック画面のスーパーインポーズ)
* バンク切り替えを使ったユーザー定義文字の利用
* プリンターBIOSの追加機能
* カナシフトロックの実装が不完全
* DOSBoxが依存するコンポーネント(SDL 1.2)の制約により日本語106キーボードへの完全対応は不可能
* IME有効時にDOSBoxウィンドウを閉じるとimetip.dllで例外が発生する
* DOSBoxがバスマウスをサポートしていないため、MS-DOS 3.21付属のMOUSE.SYSは使用できません。IBM DOS J4.0/V以降に付属するMOUSE.COMなどを使用してください。

### 必要動作環境

* Windows PC
* Microsoft Windows 11（Windows 7以降であればたぶん動く）
* Microsoft Visual C++ 2019 再頒布可能パッケージ (x86)
* AX エミュレーションの場合: FONTX2 形式の 8x19 ピクセルの日本語 SBCS フォントおよび 16x16 ピクセルの DBCS フォント ファイル
* PS/55 エミュレーションの場合: FONTX2 形式の 12x24 ピクセル日本語 SBCS フォントおよび 24x24 ピクセル DBCS フォント ファイル

### 用意するもの

#### Visual C++ 2019 再頒布可能パッケージ

doxbox.exeを実行するとエラーが出る場合は次のライブラリを入れて下さい。

最新のサポートされる Visual C++ のダウンロード
: <https://docs.microsoft.com/ja-JP/cpp/windows/latest-supported-vc-redist?view=msvc-160>

Visual Studio 2019のvc_redist.x86.exeをダウンロード・インストールして下さい。

#### FONTX2形式の日本語フォント

かつてのDOS/Vユーザーならご存じかと思いますが、FONTXとはIBM DOS/Vの表示フォントを入れ替えるフリーソフトです。そこで使われていた.FNTファイルはビットマップフォントの一つの形式としてしばしば使われました。

FONTX Lepton's Home Page
: <http://www.hmsoft.co.jp/lepton/software/dosv/fontx.htm>

FONTX2形式の日本語フォントをお持ちでなければ、上記リンクからFONTXをダウンロードしてその中にあるmkxfont.exeをWindows XP以前で実行させると、Windowsのフォントを元にFONTX2形式の日本語フォントが作成されます。（Windows Vista以降では不可）インターネット上を探せばフリーのフォントもあるかもしれません。

dosbox.confのdosboxセクションに jfontsbcs= (8x19ドットフォント)および jfontdbcs= (16x16ドットフォント)としてフォントファイルへのパスを記述して下さい。

### 使用方法

dosbox.exeを実行して下さい。dosbox_debug.exeはデバッグモニター機能がありますが、動作がやや遅くなります。基本的な使い方はDOSBoxのドキュメントを参照して下さい。以下、DOSVAXの独自拡張に絞って説明します。

#### キー割り当て

DOSBox実行中にCtrl+F1キーでキー割り当てを変更できます。AXキーなど標準で割り当てられていないキーはここで設定を変更して割り当てることができます。

```
キー     日本語モード 英語モード
右Alt    漢字         右Alt
メニュー 変換キー     Space
右Ctrl   英数カナ     右Ctrl
(割当無し AX 無変換)
```

PS/55エミュレーション時の説明は割愛。画面から察して下さい。

#### dosbox.confの設定拡張

```
[dosbox]セクション
jfontsbcs=        半角表示用FONTX2フォントファイルへのパス 8x19
jfontdbcs=        全角表示用FONTX2フォントファイルへのパス 16x16
jfontsbcs24=      半角表示用FONTX2フォントファイルへのパス 12x24
                  または、DOS K3.x半角フォントファイル ($SYSHN24.FNT) へのパス 13x30
jfontsbex24=      DOS K3.x拡張半角文字フォントファイル ($SYSEX24.FNT) へのパス 13x30 (オプション)
jfontdbcs24=      全角表示用FONTX2フォントファイルへのパス 24x24
machine=ega       AX固有の機能が有効になります。DOSBox起動時はAX英語モードです。
machine=jega      DOSBox起動時からAX日本語モードで起動します。AX版MS-DOSがなくても日本語を表示できますが、いくつかのアプリケーションは正常に動作しません。DOSの国別情報は米国のままです。
machine=svga_ps55 PS/55エミュレーションが有効になります。起動時はVGAと同等のSBCSモードです。
machine=に上記以外の値を設定すると素のDOSBoxと同様に振る舞います

[dos]セクション
keyboardlayout=jp ホストのキーボードが米国英語101キー配列ではなく日本語106/109キー配列をご利用の場合は、これを指定すると記号キーが正しく割り当てられます。ホストの変換・漢字キー等は使用できません。
```

### 変更履歴

* Build 4481PS09 (2023/01/31)
  - ビルド 4467PS01 以降、JEGA の初期化が呼び出されていない問題を修正
  - DOSBox SVR r4467 から r4481 への変更をマージ
* Build 4467PS08 (2022/02/11)
  - テキストカーソルの描画方法を改善
  - 属性コントローラのレジスタラッチ動作を変更
  - BIOS Int 17h（プリンター）で未処理の例外を無視
* Build 4467PS07 (2022/01/16)
  - DOS文書プログラムで使用される1/4フォントを生成
* Build 4467PS06 (2022/01/12)
  - DOS/Vで使用されるスキャンコードセット81hのキーボードサポートを追加（デフォルトのスキャンコードセットは、5576-002とは異なりATキーボードを継承します。）
  - DOS文書プログラムで使われる半角DBCSフォントを生成（一部のフォントはまだ正しく表示できません。）
  - システムコマンドF0h（代替スキャンコードの選択）を受信したときにキーボードがコマンドラッチをリセットしなかった問題を修正
  - PS/55モードでAXキーを押したときにエミュレータがエラーを出す問題を修正
  - EMM386が空きメモリを検出しない可能性がある問題を修正
* Build 4467PS05 (2022/01/10)
  - 反転属性がセットされている位置でのカーソル色を修正
* Build 4467PS04 (2021/12/31)
  - DOS J4.0のXMAEM.SYS (80386 XMA Emulator) を不完全に対応（日本語DOS K3.3ユーザーへ：$BANK386.SYSは異常終了するため使用しないで下さい。）
  - キーバインドの設定を変更（mapper.txtの仕様が変わっているため、新ファイルを上書きしてから再設定して下さい。）
  - 5576-001型キーボードエミュレーション起動キーを左シフト+左Ctrl+右Alt（前面）キーに修正
* Build 4467PS03 (2021/12/27)
  - FONTX2形式の12x24フォントを読み込んだときのアライメントとブランクを修正
  - PS/55拡張半角文字をロードできるようにした (ほとんどのアプリケーションでは不使用。また、DOS K3.xでは不要)
  - PS/55テキストモードで属性に点滅・縦罫線・下線を同時指定すると縦罫線が欠けるバグを修正
* Build 4467PS02 (2021/12/25)
  - PS/55単色グラフィック及び16色グラフィックモードに部分的対応 (5550相当のエミュレーションとBIOSは未実装)
  - PS/55画面モード判別ファンクションの改良 (DOS K3.3での画面モード判別は未完成)
  - PS/55キーバインド (Ctrl + F1) を実装
* Build 4467PS01 (2021/12/17)
  - 日本IBM PS/55モデル5550-S/T/V相当のエミュレーション機能を追加。使用方法はREADME_PS55.txtを参照。
* Build 4467AX13 (2021/11/14)
  - Video mode 6 (CGA互換640x200グラフィック)が正しく表示されない不具合を修正
  - Video mode 3, 53h (JEGA) のタイミングテーブルを修正(実機未確認)
  - JEGAテキスト描画ルーチンのアトリビュート解釈にあった潜在的バグを修正
  - EGA 480ラインモード時にクロックソースが25.175MHzへ切り替わるよう修正(テキストカーソル点滅速度に影響)
  - DOSBox SVNr4467の更新分を適用(過去に追加した一部の独自拡張は削除)
  - 開発環境をVisual Studio 2019へ移行 (動作に影響なし)
* Build 4000AX12 (2019/05/10)
  - AX固有キー（漢字、変換、無変換、AX）の入力を正しく実装
  - プリンターBIOS(Int 17h)で無応答ステータスを返すようにした
  - 作者クレジット・バージョン情報等を更新
  - winres.rcをVisual Studio 2017で再生成 (動作に何ら影響のない変更)
* Build 4000AX11 (2016/10/12)
  - Int 13h(15h, 16h, 18h)ファンクションを追加実装し、MS-DOS 3.21でフロッピーディスクを正しくフォーマットできるようになった
  - 読み取り専用属性のフロッピーイメージを書き込み禁止ディスクとしてマウントできるようにした(4467AX13で廃止)
  - 内蔵DOSでCHCPコマンド(コードページの取得のみ)を実装(4467AX13で廃止)
* Build 4000AX10 (2016/10/11)
  - DBCSベクター(Int 21h, AH=6300h)の返す値を修正
  - フォントパス未指定時の警告メッセージ出力
* Build 4000AX09 (2016/10/10)
  - JEGA内部レジスタ(RPSSC, RPSSU, RPSSL)でDBCS(16x16フォント)の描画開始ラインを変更できるようになった
  - 縦倍角文字表示について、行間が途切れないように修正
* Build 4000AX08 (2016/10/09)
  - JEGAグラフィックモードで文字列出力のDBCS描画を実装
  - 文字列出力で画面右端の桁にDBCSの第1バイトが来たときに折り返すようにした
  - 仮想テキストRAMを使ったグラフィック画面からの文字コード・アトリビュート取得に対応
  - テキストモードでJEGA基本アトリビュート(罫線、ブリンク、反転)、拡張アトリビュート(倍角文字、太字)に対応
* Build 4000AX07 (2016/10/07)
  - DOS/V化支援パッチ（DOS 方面（分所）<http://www2.atpages.jp/lpproj/dos/>）の一部を適用（ホストの日本語配列キーボード対応、子PSP作成時の親PSPのコピー、コンソール出力のInt10hコールバック）(4467AX13で廃止)
  - machine=jega指定時にDBCSベクタテーブルを設定するようにした
  - テキストモードで画面右端の桁にDBCSの第1バイトが書かれると異常終了する問題を修正
  - フォントファイルの入力チェックがガバガバだったので修正
  - Readme.txtの改行コードがLFのみだったためメモ帳で読めなかった問題を修正
  - DOSBox SVNr4000の更新分を適用
* Build 3998AX06 (2016/10/06)
  - AX日本語モードで起動するmachine=jegaオプションを追加
  - フォントファイルパス設定名の変更
* Build 3998AX05 (2016/10/05)
  - 公開

Copyright (C) 2016-2023 akm.

=============================README.txt END=============================